<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>To-Do List</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex">

  <div class="flex min-h-screen w-full">

    <!-- Sidebar -->
    <div class="w-1/4 bg-indigo-600 text-white shadow-lg p-6">
      <h2 class="text-2xl font-semibold mb-6">Sidebar</h2>
      <ul>
        <li class="mb-4"><a href="#" class="text-lg hover:text-indigo-300">Link 1</a></li>
        <li class="mb-4"><a href="#" class="text-lg hover:text-indigo-300">Link 2</a></li>
        <li class="mb-4"><a href="#" class="text-lg hover:text-indigo-300">Link 3</a></li>
      </ul>
    </div>

    <!-- Main -->
    <div class="flex flex-col w-full p-6">

      <!-- Top bar -->
      <div class="mb-6 bg-white shadow-lg rounded-lg p-6 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <img src="https://via.placeholder.com/50" alt="Logo" class="w-12 h-12 rounded-full">
          <h1 class="text-4xl font-bold text-center text-indigo-600">To-Do List</h1>
        </div>

        <div class="flex items-center gap-4">
          <select id="sortBy" class="p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" onchange="refreshTasks()">
            <option value="dateAdded">Sort by Date Added</option>
            <option value="priority">Sort by Priority</option>
            <option value="createdAt">Sort by Created Date</option>
          </select>

          <select id="order" class="p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" onchange="refreshTasks()">
            <option value="asc">Ascending</option>
            <option value="desc">Descending</option>
          </select>
        </div>
      </div>

      <!-- Columns -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Ongoing -->
        <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
          <h2 class="text-2xl font-semibold text-gray-700 mb-4">Ongoing Tasks</h2>
          <div id="ongoing-tasks" class="space-y-4"></div>
        </div>

        <!-- Completed -->
        <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
          <h2 class="text-2xl font-semibold text-gray-700 mb-4">Completed Tasks</h2>
          <div id="completed-tasks" class="space-y-4"></div>
        </div>

      </div>

    </div>

  </div>

  <!-- FAB -->
  <button id="addTaskBtn" class="fixed bottom-6 right-6 bg-indigo-600 text-white p-4 rounded-full shadow-lg hover:bg-indigo-500 transition-all" onclick="toggleTaskForm()">
    <i class="fas fa-plus"></i>
  </button>

  <!-- Add Task Modal -->
  <div id="taskForm" class="fixed inset-0 flex justify-center items-center bg-gray-500 bg-opacity-50 hidden">
    <div class="bg-white p-6 rounded-lg w-full max-w-lg relative" onclick="event.stopPropagation()">
      <!-- Exit/Close button -->
      <button
        type="button"
        aria-label="Close"
        class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl leading-none"
        onclick="toggleTaskForm()">
        &times;
      </button>

      <h2 class="text-2xl font-semibold text-gray-700 mb-4">Add New Task</h2>
      <form id="new-task-form" class="space-y-6">
        <div>
          <input type="text" id="title" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Task Title" required />
        </div>

        <div>
          <textarea id="description" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Task Description"></textarea>
        </div>

        <div>
          <select id="priority" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="High">High</option>
            <option value="Mid">Mid</option>
            <option value="Low">Low</option>
          </select>
        </div>

        <div class="flex justify-between space-x-4">
          <input type="date" id="dueDate" class="w-1/2 p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          <input type="time" id="dueTime" class="w-1/2 p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>

        <div class="mt-4 grid grid-cols-2 gap-3">
          <button type="button"
            class="bg-gray-200 text-gray-700 p-3 rounded-md hover:bg-gray-300 transition-all"
            onclick="toggleTaskForm()">
            Cancel
          </button>
          <button type="submit" class="bg-indigo-600 text-white p-3 rounded-md hover:bg-indigo-500 transition-all">
            Add Task
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Update Task Modal -->
  <div id="updateTaskModal" class="fixed inset-0 flex justify-center items-center bg-gray-500 bg-opacity-50 hidden" onclick="closeUpdateTaskModal(event)">
    <div class="bg-white p-6 rounded-lg w-full max-w-lg" onclick="event.stopPropagation()">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">Update Task</h2>
      <form id="update-task-form" class="space-y-6">
        <div>
          <input type="text" id="update-title" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Task Title" required />
        </div>
        <div>
          <textarea id="update-description" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Task Description"></textarea>
        </div>
        <div>
          <select id="update-priority" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="High">High</option>
            <option value="Mid">Mid</option>
            <option value="Low">Low</option>
          </select>
        </div>
        <div class="flex justify-between space-x-4">
          <input type="date" id="update-dueDate" class="w-1/2 p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          <input type="time" id="update-dueTime" class="w-1/2 p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div class="mt-4 text-center">
          <button type="submit" class="bg-indigo-600 text-white p-3 rounded-md w-full hover:bg-indigo-500 transition-all">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const ongoingTasks = document.getElementById('ongoing-tasks');
    const completedTasks = document.getElementById('completed-tasks');
    const newTaskForm = document.getElementById('new-task-form');
    const taskForm = document.getElementById('taskForm');
    const updateTaskModal = document.getElementById('updateTaskModal');
    const updateTaskForm = document.getElementById('update-task-form');
    const API_BASE = 'http://127.0.0.1:5000/api/tasks';
    let currentTaskId = null;

    // Fetch and display tasks
    function fetchTasks(sortBy = "dateAdded", order = "asc") {
      const currentSortBy = document.getElementById('sortBy').value;
      const currentOrder = document.getElementById('order').value;

      fetch(`${API_BASE}?sortBy=${currentSortBy}&order=${currentOrder}`)
        .then(response => response.json())
        .then(data => {
          ongoingTasks.innerHTML = '';
          completedTasks.innerHTML = '';

          data.forEach(task => {
            const taskItem = document.createElement('div');
            taskItem.classList.add('p-4', 'mb-4', 'border', 'border-gray-200', 'rounded-lg', 'shadow-md');

            if (task.isDone) {
              taskItem.classList.add('opacity-70', 'bg-green-50');
            } else {
              taskItem.classList.add('bg-white');
            }

            // PRIORITY COLOR TAG + CREATED TIMESTAMP
            const pClass =
              task.priority === 'High'
                ? 'bg-red-100 text-red-700'
                : task.priority === 'Low'
                ? 'bg-green-100 text-green-700'
                : 'bg-yellow-100 text-yellow-700'; // Mid

            taskItem.innerHTML = `
              <h3 class="text-lg font-semibold">${task.title}</h3>
              <p class="text-gray-600">${task.description || 'No description'}</p>

              <div class="mt-1 flex items-center gap-2 text-sm">
                <span class="px-2 py-0.5 rounded text-xs font-semibold ${pClass}">
                  ${task.priority}
                </span>
                <span class="text-gray-500">• Due: ${task.dueDate || '—'}${task.dueTime ? ' at ' + task.dueTime : ''}</span>
              </div>

              <p class="text-xs text-gray-400 mt-1">
                Created: ${task.createdAt ? new Date(task.createdAt).toLocaleString() : '—'}
              </p>

              <div class="mt-2 flex gap-2 items-center">
                <button class="bg-green-500 text-white p-2 rounded-md hover:bg-green-600" onclick="openUpdateTaskModal(${task.id})">Update</button>
                <button class="bg-red-500 text-white p-2 rounded-md hover:bg-red-600" onclick="deleteTask(${task.id})">Delete</button>
                <label class="flex items-center space-x-2 cursor-pointer">
                  <input type="checkbox" onchange="toggleTaskCompletion(this, ${task.id})" ${task.isDone ? 'checked' : ''} class="w-4 h-4 text-indigo-600 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500">
                  <span>${task.isDone ? 'Mark as Ongoing' : 'Mark as Completed'}</span>
                </label>
              </div>
            `;

            if (task.isDone) {
              completedTasks.appendChild(taskItem);
            } else {
              ongoingTasks.appendChild(taskItem);
            }
          });
        })
        .catch(error => console.error('Error fetching tasks:', error));
    }

    // Handle task creation
    newTaskForm.addEventListener('submit', function (event) {
      event.preventDefault();

      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      const priority = document.getElementById('priority').value;
      const dueDate = document.getElementById('dueDate').value;
      const dueTime = document.getElementById('dueTime').value;

      const newTask = { title, description, priority, dueDate, dueTime };

      fetch(API_BASE, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newTask),
      })
        .then(response => {
          if (!response.ok) throw new Error('Task creation failed.');
          return response.json();
        })
        .then(() => {
          fetchTasks();
          newTaskForm.reset();
          taskForm.classList.add('hidden');
        })
        .catch(error => alert('Error creating task: ' + error.message));
    });

    // Handle task deletion
    function deleteTask(taskId) {
      if (!confirm("Are you sure you want to delete this task?")) return;

      fetch(`${API_BASE}/${taskId}`, { method: 'DELETE' })
        .then(response => {
          if (!response.ok && response.status !== 204) throw new Error('Task deletion failed.');
          fetchTasks();
        })
        .catch(error => alert('Error deleting task: ' + error.message));
    }

    // Open update modal
    function openUpdateTaskModal(taskId) {
      currentTaskId = taskId;
      fetch(`${API_BASE}/${taskId}`)
        .then(response => {
          if (!response.ok) throw new Error('Task not found.');
          return response.json();
        })
        .then(task => {
          document.getElementById('update-title').value = task.title;
          document.getElementById('update-description').value = task.description || '';
          document.getElementById('update-priority').value = task.priority;
          document.getElementById('update-dueDate').value = task.dueDate || '';
          document.getElementById('update-dueTime').value = task.dueTime || '';
          updateTaskModal.classList.remove('hidden');
        })
        .catch(error => alert('Error fetching task for update: ' + error.message));
    }

    // Close update modal when clicking backdrop
    function closeUpdateTaskModal(event) {
      if (event.target === updateTaskModal) {
        updateTaskModal.classList.add('hidden');
      }
    }

    // Save update
    updateTaskForm.addEventListener('submit', function (event) {
      event.preventDefault();

      const title = document.getElementById('update-title').value;
      const description = document.getElementById('update-description').value;
      const priority = document.getElementById('update-priority').value;
      const dueDate = document.getElementById('update-dueDate').value;
      const dueTime = document.getElementById('update-dueTime').value;

      const updatedTask = { title, description, priority, dueDate, dueTime };

      fetch(`${API_BASE}/${currentTaskId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedTask),
      })
        .then(response => {
          if (!response.ok) throw new Error('Task update failed.');
          return response.json();
        })
        .then(() => {
          fetchTasks();
          updateTaskModal.classList.add('hidden');
        })
        .catch(error => alert('Error updating task: ' + error.message));
    });

    // Toggle completion
    function toggleTaskCompletion(checkboxElement, taskId) {
      const isDone = checkboxElement.checked;

      fetch(`${API_BASE}/${taskId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ isDone }),
      })
        .then(response => {
          if (!response.ok) throw new Error('Completion status update failed.');
          return response.json();
        })
        .then(() => fetchTasks())
        .catch(error => {
          alert('Error updating task completion: ' + error.message);
          checkboxElement.checked = !isDone;
        });
    }

    // Close Add Task when clicking outside the card
    taskForm.addEventListener('click', (e) => {
      if (e.target === taskForm) toggleTaskForm();
    });

    // Refresh handler
    function refreshTasks() { fetchTasks(); }

    // Toggle Add Task popup
    function toggleTaskForm() {
      taskForm.classList.toggle('hidden');
    }

    // Initial load
    fetchTasks();
  </script>

  </body>
</html>
